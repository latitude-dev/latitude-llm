# Async Span Download Implementation Progress

## Implementation Order (from PRD)
1. [x] Pass filters through components - Wire up the filters prop
2. [x] Add batch repository methods - `findCompletionsByParentIds`, `getBatch`
3. [x] Create exportSpansJob - Streaming job with batch processing
4. [x] Create downloadSpansAction - Server action routing sync/async
5. [ ] Update DownloadSpansButton - Handle async response with toast

## Completed Tasks

### Task 1: Pass filters through components (2026-01-16)
**Commit:** 4b26d523f

**Changes:**
- `DocumentTracesPage.tsx`: Added `filters={filters}` prop to `SelectionTracesBanner` component
- `SelectionTracesBanner/index.tsx`: Added `filters: SpansFilters` prop and passed it to `DownloadSpansButton`
- `DownloadSpansButton/index.tsx`: Added `filters: SpansFilters` prop (prefixed with _ as unused for now)

**Files modified:**
- apps/web/src/app/(private)/projects/[projectId]/versions/[commitUuid]/documents/[documentUuid]/(withTabs)/traces/_components/DocumentTracesPage.tsx
- apps/web/src/app/(private)/projects/[projectId]/versions/[commitUuid]/documents/[documentUuid]/(withTabs)/traces/_components/SelectionTracesBanner/index.tsx
- apps/web/src/app/(private)/projects/[projectId]/versions/[commitUuid]/documents/[documentUuid]/(withTabs)/traces/_components/SelectionTracesBanner/DownloadSpansButton/index.tsx

### Task 2: Add batch repository methods (2026-01-16)

**Changes:**
- `SpansRepository`: Added `findCompletionsByParentIds()` method for batch fetching completion spans by their parent prompt span IDs. Uses a single SQL query with OR conditions to fetch all completions at once, returning a Map keyed by `traceId:parentId`.
- `SpanMetadatasRepository`: Added `getBatch()` method for parallel fetching of span metadata. Uses `Promise.all` to fetch multiple metadata entries in parallel, returning a Map keyed by `traceId:spanId`.

**Files modified:**
- packages/core/src/repositories/spansRepository.ts

### Task 3: Create exportSpansJob - Streaming job with batch processing (2026-01-16)

**Changes:**
- Created `packages/core/src/jobs/job-definitions/exports/exportSpansJob.ts` with:
  - `ExportSpansJobData` type definition for job input
  - `enqueueExportSpansJob()` function to add job to defaultQueue
  - `exportSpansJob` handler implementing streaming CSV generation
  - Cursor-based pagination via async generator `iterateSpans()`
  - Batch processing with `buildRowsForBatch()` to avoid N+1 queries
  - Uses `findCompletionsByParentIds()` and `getBatch()` for batch DB operations
  - Streams CSV directly to disk via PassThrough stream
  - Calls `markExportReady()` on completion to trigger email notification
- Created `packages/core/src/jobs/job-definitions/exports/index.ts` barrel export
- Registered job in `packages/core/src/jobs/job-definitions/index.ts`
- Added job mapping in `apps/workers/src/workers/worker-definitions/defaultWorker.ts`

**Key implementation details:**
- BATCH_SIZE = 500 spans per iteration to balance memory vs DB round trips
- Supports ALL, ALL_EXCEPT, and PARTIAL selection modes
- Uses Set for O(1) excluded span lookup
- Fixed columns: label, span_id, trace_id, tokens
- CSV rows built from prompt span metadata and completion span output

**Files created:**
- packages/core/src/jobs/job-definitions/exports/exportSpansJob.ts
- packages/core/src/jobs/job-definitions/exports/index.ts

**Files modified:**
- packages/core/src/jobs/job-definitions/index.ts
- apps/workers/src/workers/worker-definitions/defaultWorker.ts

### Task 4: Create downloadSpansAction - Server action routing sync/async (2026-01-16)

**Changes:**
- Created `apps/web/src/actions/spans/downloadSpans.ts` with:
  - `downloadSpansAction` using `withDocument` procedure for authentication and document context
  - Input schema accepting: selectionMode, selectedSpanIdentifiers, excludedSpanIdentifiers, filters
  - Sync mode: For PARTIAL selections with â‰¤25 spans, returns `{ mode: 'sync', spanIdentifiers }` for immediate client-side download
  - Async mode: For ALL/ALL_EXCEPT modes or large PARTIAL selections:
    - Generates export UUID via `crypto.randomUUID()`
    - Creates export record via `findOrCreateExport` service
    - Enqueues `exportSpansJob` to defaultQueue with all necessary data
    - Returns `{ mode: 'async', exportUuid }` to signal background processing

**Key implementation details:**
- Uses `withDocumentSchema.extend()` pattern for type-safe input validation
- Maps `SpansFilters` to `ExportSpansJobData['filters']` format
- For PARTIAL mode with >25 spans, passes `selectedSpanIdentifiers` to job for filtering
- Reuses existing export infrastructure (exports table, email notification flow)

**Files created:**
- apps/web/src/actions/spans/downloadSpans.ts

## Next Task
Task 5: Update DownloadSpansButton - Handle async response with toast
